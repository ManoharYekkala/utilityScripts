#!/bin/bash

# Simple script to create PRs: current-branch → staging → prod

STAGING_BRANCH="staging"
PROD_BRANCH="prod"  # Change to 'main' or 'master' if needed
DEV_BRANCH="dev"

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "Current branch: $CURRENT_BRANCH"

# Push current branch
echo "Pushing $CURRENT_BRANCH to origin..."
git push origin $CURRENT_BRANCH

# Create PR from current branch to dev and auto-merge if no conflicts
echo "Creating PR: $CURRENT_BRANCH → $DEV_BRANCH"
DEV_PR_URL=$(gh pr create --base $DEV_BRANCH --head $CURRENT_BRANCH --title "Merge $CURRENT_BRANCH to dev" --body "Auto-generated PR")

if [ $? -eq 0 ]; then
    echo "Dev PR created successfully. Checking for conflicts..."
    # Wait a moment for GitHub to process the PR
    sleep 2
    
    # Check if the PR can be merged (no conflicts)
    PR_NUMBER=$(echo $DEV_PR_URL | sed 's|.*/pull/||')
    MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable -q '.mergeable')
    
    if [ "$MERGEABLE" = "MERGEABLE" ]; then
        echo "No conflicts detected. Auto-merging dev PR..."
        gh pr merge $PR_NUMBER --merge --delete-branch=false
        echo "Dev PR merged successfully!"
    else
        echo "Conflicts detected in dev PR. Manual intervention required."
        echo "Dev PR URL: $DEV_PR_URL"
    fi
else
    echo "Failed to create dev PR"
fi

# Create PR from current branch to staging
echo "Creating PR: $CURRENT_BRANCH → $STAGING_BRANCH"
gh pr create --base $STAGING_BRANCH --head $CURRENT_BRANCH --title "Merge $CURRENT_BRANCH to staging" --body "Auto-generated PR"
